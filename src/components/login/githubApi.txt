import React, { useState } from "react";
import { ScrollView, Pressable, Text, View, Image, ActivityIndicator } from "react-native";
import { WebView } from "react-native-webview";
import { useRouter } from "expo-router";
import auth from "@react-native-firebase/auth";


export interface TextButton {
  text: string;
  onPress: () => void;
}


const GitHubLogin = () => {
  const [showWebView, setShowWebView] = useState(false);
  const [loading, setLoading] = useState(false); 

  const firebaseRedirectUrl = "https://skillswap-1104.firebaseapp.com/__/auth/handler";
  const githubAuthUrl = `https://github.com/login/oauth/authorize?client_id=Ov23ctIhG1633Ta1Yx78&redirect_uri=${firebaseRedirectUrl}&scope=read:user`;

  const handleNavigationStateChange = async (event: { url: string }) => {
    const url = event.url;

    if (url.startsWith(firebaseRedirectUrl) && url.includes("code=")) {
      setLoading(true);
      setShowWebView(false); // Fecha o WebView

      const code = new URLSearchParams(new URL(url).search).get("code");

      try {
        if (code) {
          const credential = auth.GithubAuthProvider.credential(code);
          const userCredential = await auth().signInWithCredential(credential);

          console.log("Usuário logado:", userCredential.user);
        } else {
          console.error("Código de autenticação não encontrado.");
        }
      } catch (error) {
        console.error("Erro ao autenticar:", error);
      } finally {
        setLoading(false);
      }
    }
  };

  return (
    <View style={{ flex: 1, justifyContent: "center", alignItems: "center" }}>
      {loading && <ActivityIndicator size="large" color="#6f00ff" />} 
      {!showWebView && !loading && (
        <Pressable
          style={{
            backgroundColor: "#6f00ff",
            borderRadius: 20,
            paddingVertical: 10,
            paddingHorizontal: 20,
          }}
          onPress={() => setShowWebView(true)}
        >
          <Text style={{ color: "#fff", fontWeight: "700", fontSize: 16 }}>Login com GitHub</Text>
        </Pressable>
      )}
      {showWebView && (
        <WebView
          source={{ uri: githubAuthUrl }}
          onNavigationStateChange={handleNavigationStateChange}
          style={{ flex: 1, width: "100%" }}
        />
      )}
    </View>
  );
};


export function ButtonLogin({ text, onPress }: TextButton) {
  return (
    <Pressable
      style={{ backgroundColor: "#6f00ff" }}
      className="text-gray-300 border border-indigo-600 w-96 rounded-full h-14 mt-8 flex items-center justify-center"
      onPress={onPress}
    >
      <Text
        className="text-white text-2xl"
        style={{
          fontWeight: "700",
          letterSpacing: 1.5,
          shadowColor: "cyan",
          shadowOffset: { width: -2, height: 4 },
          shadowOpacity: 0.4,
          shadowRadius: 3,
        }}
      >
        {text}
      </Text>
    </Pressable>
  );
}


export function ResetPassword() {
  const router = useRouter();

  return (
    <Pressable onPress={() => router.push("/(stack)/resetPassword")}>
      <Text
        className="text-gray-300 ml-48 mt-5"
        style={{
          fontWeight: "700",
          letterSpacing: 1.3,
        }}
      >
        Esqueceu sua senha?
      </Text>
    </Pressable>
  );
}

export function OthersLogins() {
  return (
    <Pressable className="mt-16">
      <Text
        className="text-gray-300 text-center"
        style={{ fontWeight: "700", letterSpacing: 1.3 }}
      >
        ou logue com
      </Text>
    </Pressable>
  );
}

export function ImagesEnterprise() {
  const [showWebView, setShowWebView] = useState(false);

  return (
    <View className="flex-row gap-10 items-center">
      <Pressable className="mt-3 bg-neutral-800 py-3 px-8 rounded-xl">
        <Image source={require("../../assets/google.png")} />
      </Pressable>
      <Pressable className="mt-3 bg-neutral-800 py-3 px-8 rounded-xl">
        <Image source={require("../../assets/linkedin.png")} />
      </Pressable>
      <Pressable
        className="mt-3 bg-neutral-800 py-3 px-8 rounded-xl"
        onPress={() => setShowWebView(true)}
      >
        <Image source={require("../../assets/github.png")} />
      </Pressable>
      {showWebView && (
        <WebView
          source={{
            uri: `https://github.com/login/oauth/authorize?client_id=Ov23ctIhG1633Ta1Yx78`,
          }}
          style={{ flex: 1 }}
        />
      )}
    </View>
  );
}

export function CreateAccount() {
  const router = useRouter();

  return (
    <View className="flex-row gap-10 items-center">
      <Pressable
        className="flex-grid"
        onPress={() => router.replace("/register")}
      >
        <Text
          style={{
            fontWeight: "700",
            letterSpacing: 1.3,
          }}
          className="text-gray-300 text-center mt-10"
        >
          Não possui conta?
        </Text>
        <Text
          className="text-indigo-400 text-center mt-2"
          style={{
            textDecorationLine: "underline",
            fontWeight: "700",
            letterSpacing: 1.3,
          }}
        >
          Crie aqui!
        </Text>
      </Pressable>
    </View>
  );
}

export default GitHubLogin;
